<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Apartment Maintenance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
            min-height: 100vh;
        }
        
        input, select, textarea, button {
            font-size: 16px !important;
        }
        
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
            color: white;
            padding: 24px 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .month-selector {
            background: white;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .month-selector label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }
        
        .month-selector input {
            width: 100%;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
        }
        
        .content {
            padding: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            padding: 16px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .stat-card.full-width {
            grid-column: 1 / -1;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-detail {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 12px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .action-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-btn.green {
            background: #10b981;
        }
        
        .action-btn.red {
            background: #ef4444;
        }
        
        .action-btn.blue {
            background: #3b82f6;
        }
        
        .item-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        
        .item-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .item-subtitle {
            font-size: 14px;
            color: #6b7280;
        }
        
        .item-amount {
            font-weight: bold;
            color: #1f2937;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.paid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.pending {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-badge.partial {
            background: #fef3c7;
            color: #92400e;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            z-index: 50;
        }
        
        .nav-btn {
            background: none;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6b7280;
        }
        
        .nav-btn.active {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
            font-weight: 600;
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            z-index: 101;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-input, .form-select {
            width: 100%;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-text {
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        .category-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .vendor-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #f3f4f6;
            color: #4b5563;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .edit-btn, .delete-btn {
            font-size: 12px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 4px;
            margin-right: 12px;
        }
        
        .edit-btn {
            color: #3b82f6;
        }
        
        .delete-btn {
            color: #ef4444;
        }
        
        .item-footer {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .balance-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .balance-label {
            font-size: 14px;
            color: #6b7280;
        }
        
        .balance-value {
            font-weight: 600;
            font-size: 16px;
            color: #1f2937;
        }
        
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            pointer-events: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .add-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }
        
        .arrears-indicator {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 12px;
            color: #92400e;
        }
        
        .advance-indicator {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 12px;
            color: #1e40af;
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="saveIndicator" class="save-indicator hidden">‚úì Saved</div>
    
    <script>
        const START_MONTH = '2026-01';
        
        let state = {
            activeTab: 'dashboard',
            selectedMonth: START_MONTH,
            flats: [],
            expenditures: [],
            modals: {
                addFlat: false,
                addPayment: false,
                addExpenditure: false,
                editExpenditure: null,
                flatDetails: null,
                collectionDetails: false,
                expenditureDetails: false,
                arrearsDetails: false
            },
            paymentMonthForDate: START_MONTH,
            selectedFlatForPayment: null
        };
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 3000);
        }
        
        function loadData() {
            try {
                const savedFlats = localStorage.getItem('apartmentFlats');
                const savedExpenditures = localStorage.getItem('apartmentExpenditures');
                if (savedFlats) state.flats = JSON.parse(savedFlats);
                if (savedExpenditures) state.expenditures = JSON.parse(savedExpenditures);
                if (state.selectedMonth < START_MONTH) state.selectedMonth = START_MONTH;
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem('apartmentFlats', JSON.stringify(state.flats));
                localStorage.setItem('apartmentExpenditures', JSON.stringify(state.expenditures));
                showSaveIndicator();
            } catch (error) {
                console.error('Error saving data:', error);
                alert('‚ö†Ô∏è Unable to save data');
            }
        }
        
        function calculateArrears(flat, upToMonth) {
            if (upToMonth === START_MONTH) return flat.openingArrears || 0;
            
            let totalDue = 0;
            let totalPaid = 0;
            const currentDate = new Date(upToMonth + '-01');
            const startDate = new Date(START_MONTH + '-01');
            let checkDate = new Date(startDate);
            
            while (checkDate < currentDate) {
                totalDue += flat.monthlyFee;
                checkDate.setMonth(checkDate.getMonth() + 1);
            }
            
            totalDue += (flat.openingArrears || 0);
            
            flat.payments.forEach(payment => {
                const paymentDate = new Date(payment.month + '-01');
                if (paymentDate < currentDate && paymentDate >= startDate) {
                    totalPaid += payment.amount;
                }
            });
            
            return totalPaid - totalDue;
        }
        
        function getPaymentStatusWithBalance(flat, month) {
            const balance = calculateArrears(flat, month);
            const currentMonthPayment = flat.payments.find(p => p.month === month);
            const currentMonthPaid = currentMonthPayment ? currentMonthPayment.amount : 0;
            const totalAvailable = balance + currentMonthPaid;
            
            if (totalAvailable >= flat.monthlyFee) {
                return {
                    status: 'Paid',
                    balance: totalAvailable - flat.monthlyFee,
                    type: totalAvailable - flat.monthlyFee > 0 ? 'advance' : 'exact'
                };
            } else if (currentMonthPaid > 0) {
                return { status: 'Partial', balance: totalAvailable - flat.monthlyFee, type: 'arrears' };
            } else {
                return { status: 'Pending', balance: totalAvailable - flat.monthlyFee, type: 'arrears' };
            }
        }
        
        function getPreviousMonth(monthStr) {
            const date = new Date(monthStr + '-01');
            date.setMonth(date.getMonth() - 1);
            return date.toISOString().slice(0, 7);
        }
        
        function getBalanceCarriedForward(month) {
            if (month === START_MONTH) return { cash: 0, bank: 0, total: 0 };
            const prevMonth = getPreviousMonth(month);
            const prevStats = getMonthlyStatsForMonth(prevMonth);
            return { cash: prevStats.closingCash, bank: prevStats.closingBank, total: prevStats.closingCash + prevStats.closingBank };
        }
        
        function getMonthlyStatsForMonth(month) {
            const monthPayments = state.flats.flatMap(flat => flat.payments.filter(p => p.month === month));
            const monthExpenditures = state.expenditures.filter(exp => exp.date.slice(0, 7) === month);
            
            const cashCollections = monthPayments.filter(p => p.method === 'Cash').reduce((sum, p) => sum + p.amount, 0);
            const bankCollections = monthPayments.reduce((sum, p) => p.method !== 'Cash' ? sum + p.amount : sum, 0);
            const totalCollected = cashCollections + bankCollections;
            
            const cashExpenditure = monthExpenditures.filter(e => e.paymentMethod === 'Cash').reduce((sum, e) => sum + e.amount, 0);
            const bankExpenditure = monthExpenditures.reduce((sum, e) => e.paymentMethod !== 'Cash' ? sum + e.amount : sum, 0);
            const totalExpenditure = cashExpenditure + bankExpenditure;
            
            const balanceCF = getBalanceCarriedForward(month);
            const closingCash = balanceCF.cash + cashCollections - cashExpenditure;
            const closingBank = balanceCF.bank + bankCollections - bankExpenditure;
            
            let paidFlats = 0, totalArrears = 0, totalAdvance = 0;
            
            state.flats.forEach(flat => {
                const statusInfo = getPaymentStatusWithBalance(flat, month);
                if (statusInfo.status === 'Paid') paidFlats++;
                if (statusInfo.balance < 0) totalArrears += Math.abs(statusInfo.balance);
                else if (statusInfo.balance > 0) totalAdvance += statusInfo.balance;
            });
            
            return {
                totalCollected, cashCollections, bankCollections,
                totalExpenditure, cashExpenditure, bankExpenditure,
                balance: totalCollected - totalExpenditure,
                paidFlats, totalFlats: state.flats.length,
                pendingFlats: state.flats.length - paidFlats,
                monthPayments, monthExpenditures,
                totalArrears, totalAdvance,
                openingCash: balanceCF.cash, openingBank: balanceCF.bank,
                closingCash, closingBank
            };
        }
        
        function getMonthlyStats() {
            return getMonthlyStatsForMonth(state.selectedMonth);
        }
        
        function getPaymentStatus(flat) {
            return getPaymentStatusWithBalance(flat, state.selectedMonth).status;
        }
        
        function setActiveTab(tab) {
            state.activeTab = tab;
            render();
        }
        
        function setSelectedMonth(month) {
            if (month >= START_MONTH) {
                state.selectedMonth = month;
                state.paymentMonthForDate = month;
                render();
            } else {
                alert('Cannot select months before January 2026');
            }
        }
        
        function openModal(modal) {
            state.modals[modal] = true;
            render();
        }
        
        function closeModal(modal) {
            state.modals[modal] = false;
            if (modal === 'addPayment') state.selectedFlatForPayment = null;
            render();
        }
        
        function showFlatPayment(flat) {
            state.selectedFlatForPayment = flat;
            state.modals.addPayment = true;
            render();
        }
        
        function openEditExpenditure(exp) {
            state.modals.editExpenditure = exp;
            render();
        }
        
        function updatePaymentMonth(month) {
            state.paymentMonthForDate = month;
            render();
        }
        
        function getDateRangeForMonth(monthStr) {
            const year = parseInt(monthStr.split('-')[0]);
            const month = parseInt(monthStr.split('-')[1]);
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            return {
                minDate: firstDay.toISOString().slice(0, 10),
                maxDate: lastDay.toISOString().slice(0, 10)
            };
        }
        
        function addFlat(e) {
            e.preventDefault();
            const form = e.target;
            state.flats.push({
                id: Date.now(),
                flatNumber: form.flatNumber.value,
                ownerName: form.ownerName.value,
                monthlyFee: parseFloat(form.monthlyFee.value),
                phoneNumber: form.phoneNumber.value,
                openingArrears: parseFloat(form.openingArrears.value) || 0,
                payments: []
            });
            saveData();
            closeModal('addFlat');
            form.reset();
        }
        
        function recordPayment(e) {
            e.preventDefault();
            const form = e.target;
            const flatId = parseInt(form.flatId.value);
            const flat = state.flats.find(f => f.id === flatId);
            const selectedMonth = form.month.value;
            const paymentDate = form.date.value;
            
            if (selectedMonth < START_MONTH) {
                alert('Cannot record payments before January 2026');
                return;
            }
            
            if (paymentDate.slice(0, 7) !== selectedMonth) {
                alert('Payment date must be within selected month');
                return;
            }
            
            if (flat) {
                flat.payments.push({
                    id: Date.now(),
                    month: selectedMonth,
                    amount: parseFloat(form.amount.value),
                    date: paymentDate,
                    method: form.method.value
                });
                saveData();
                closeModal('addPayment');
                form.reset();
            }
        }
        
        function addExpenditure(e) {
            e.preventDefault();
            const form = e.target;
            const expDate = form.date.value;
            
            if (expDate.slice(0, 7) < START_MONTH) {
                alert('Cannot add expenditures before January 2026');
                return;
            }
            
            state.expenditures.push({
                id: Date.now(),
                description: form.description.value,
                category: form.category.value,
                amount: parseFloat(form.amount.value),
                date: expDate,
                vendor: form.vendor.value,
                paymentMethod: form.paymentMethod.value
            });
            saveData();
            closeModal('addExpenditure');
            form.reset();
        }
        
        function updateExpenditure(e) {
            e.preventDefault();
            const form = e.target;
            const expId = parseInt(form.expId.value);
            const expIndex = state.expenditures.findIndex(e => e.id === expId);
            const expDate = form.date.value;
            
            if (expDate.slice(0, 7) < START_MONTH) {
                alert('Cannot set date before January 2026');
                return;
            }
            
            if (expIndex !== -1) {
                state.expenditures[expIndex] = {
                    ...state.expenditures[expIndex],
                    description: form.description.value,
                    category: form.category.value,
                    amount: parseFloat(form.amount.value),
                    date: expDate,
                    vendor: form.vendor.value,
                    paymentMethod: form.paymentMethod.value
                };
                saveData();
                state.modals.editExpenditure = null;
            }
        }
        
        function deleteExpenditure(id) {
            if (confirm('Delete this expenditure?')) {
                state.expenditures = state.expenditures.filter(e => e.id !== id);
                saveData();
                render();
            }
        }
        
        function renderDashboard() {
            const stats = getMonthlyStats();
            const pendingFlats = state.flats.filter(f => getPaymentStatus(f) === 'Pending');
            
            return `
                <div class="stats-grid">
                    <div class="stat-card green" onclick="openModal('collectionDetails')">
                        <div class="stat-label">Collected</div>
                        <div class="stat-value">‚Çπ${(stats.totalCollected/1000).toFixed(1)}k</div>
                        <div class="stat-detail">${stats.paidFlats}/${stats.totalFlats} paid</div>
                    </div>
                    <div class="stat-card red" onclick="openModal('expenditureDetails')">
                        <div class="stat-label">Spent</div>
                        <div class="stat-value">‚Çπ${(stats.totalExpenditure/1000).toFixed(1)}k</div>
                        <div class="stat-detail">${stats.monthExpenditures.length} items</div>
                    </div>
                    ${stats.totalArrears > 0 ? `
                    <div class="stat-card orange" onclick="openModal('arrearsDetails')">
                        <div class="stat-label">Arrears</div>
                        <div class="stat-value">‚Çπ${stats.totalArrears.toLocaleString()}</div>
                    </div>` : ''}
                    ${stats.totalAdvance > 0 ? `
                    <div class="stat-card purple">
                        <div class="stat-label">Advance</div>
                        <div class="stat-value">‚Çπ${stats.totalAdvance.toLocaleString()}</div>
                    </div>` : ''}
                    <div class="stat-card ${stats.balance >= 0 ? 'blue' : 'orange'} full-width">
                        <div class="stat-label">Balance</div>
                        <div class="stat-value">‚Çπ${stats.balance.toLocaleString()}</div>
                        <div class="stat-detail">Cash: ‚Çπ${stats.closingCash.toLocaleString()} ‚Ä¢ Bank: ‚Çπ${stats.closingBank.toLocaleString()}</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Cash & Bank</div>
                    <div class="balance-card">
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb;">
                            <span class="balance-label">Opening Cash</span>
                            <span class="balance-value">‚Çπ${stats.openingCash.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb;">
                            <span class="balance-label">+ Collections</span>
                            <span class="balance-value" style="color: #10b981;">‚Çπ${stats.cashCollections.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb;">
                            <span class="balance-label">- Expenses</span>
                            <span class="balance-value" style="color: #ef4444;">‚Çπ${stats.cashExpenditure.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 2px solid #1f2937;">
                            <span class="balance-label" style="font-weight: 600;">Closing Cash</span>
                            <span class="balance-value" style="font-size: 18px; color: #10b981;">‚Çπ${stats.closingCash.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb; margin-top: 12px;">
                            <span class="balance-label">Opening Bank</span>
                            <span class="balance-value">‚Çπ${stats.openingBank.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb;">
                            <span class="balance-label">+ Collections</span>
                            <span class="balance-value" style="color: #10b981;">‚Çπ${stats.bankCollections.toLocaleString()}</span>
                        </div>
                        <div class="balance-row" style="border-bottom: 1px solid #e5e7eb;">
                            <span class="balance-label">- Expenses</span>
                            <span class="balance-value" style="color: #ef4444;">‚Çπ${stats.bankExpenditure.toLocaleString()}</span>
                        </div>
                        <div class="balance-row">
                            <span class="balance-label" style="font-weight: 600;">Closing Bank</span>
                            <span class="balance-value" style="font-size: 18px; color: #3b82f6;">‚Çπ${stats.closingBank.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Quick Actions</div>
                    <div class="quick-actions">
                        <button class="action-btn green" onclick="openModal('addPayment')">üí∞ Payment</button>
                        <button class="action-btn red" onclick="openModal('addExpenditure')">üí∏ Expense</button>
                    </div>
                </div>
                
                ${stats.pendingFlats > 0 ? `
                <div class="section">
                    <div class="section-title">Pending (${stats.pendingFlats})</div>
                    <div class="item-list">
                        ${pendingFlats.map(flat => {
                            const statusInfo = getPaymentStatusWithBalance(flat, state.selectedMonth);
                            return `
                            <div class="item" onclick='showFlatPayment(${JSON.stringify(flat).replace(/'/g, "&apos;")})'>
                                <div class="item-header">
                                    <div>
                                        <div class="item-title">${flat.flatNumber}</div>
                                        <div class="item-subtitle">${flat.ownerName}</div>
                                    </div>
                                    <div class="item-amount" style="color: #ef4444;">‚Çπ${flat.monthlyFee}</div>
                                </div>
                                ${statusInfo.balance < 0 ? `
                                <div class="arrears-indicator">Arrears: ‚Çπ${Math.abs(statusInfo.balance).toLocaleString()}</div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>` : ''}
            `;
        }
        
        function renderFlats() {
            return `
                <div class="section-header">
                    <div class="section-title">Flats (${state.flats.length})</div>
                    <button class="add-btn" onclick="openModal('addFlat')">+ Add</button>
                </div>
                ${state.flats.length === 0 ? `
                    <div class="section">
                        <div class="empty-state">
                            <div class="empty-icon">üè¢</div>
                            <div class="empty-text">No flats added</div>
                            <button class="action-btn blue" onclick="openModal('addFlat')">Add First Flat</button>
                        </div>
                    </div>
                ` : state.flats.map(flat => {
                    const status = getPaymentStatus(flat);
                    const statusInfo = getPaymentStatusWithBalance(flat, state.selectedMonth);
                    const statusClass = status === 'Paid' ? 'paid' : status === 'Partial' ? 'partial' : 'pending';
                    return `
                        <div class="section" onclick='showFlatPayment(${JSON.stringify(flat).replace(/'/g, "&apos;")})'>
                            <div class="item-header">
                                <div>
                                    <div class="item-title" style="font-size: 18px;">${flat.flatNumber}</div>
                                    <div class="item-subtitle">${flat.ownerName}</div>
                                </div>
                                <span class="status-badge ${statusClass}">${status}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 14px; color: #6b7280;">Monthly Fee</div>
                                <div style="font-size: 18px; font-weight: bold;">‚Çπ${flat.monthlyFee}</div>
                            </div>
                            ${statusInfo.balance < 0 ? `
                            <div class="arrears-indicator">Arrears: ‚Çπ${Math.abs(statusInfo.balance).toLocaleString()}</div>
                            ` : statusInfo.balance > 0 ? `
                            <div class="advance-indicator">Advance: ‚Çπ${statusInfo.balance.toLocaleString()}</div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }
        
        function renderExpenses() {
            const stats = getMonthlyStats();
            const categoryTotals = stats.monthExpenditures.reduce((acc, exp) => {
                acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
                return acc;
            }, {});
            
            return `
                <div class="section-header">
                    <div class="section-title">Expenses</div>
                    <button class="add-btn" onclick="openModal('addExpenditure')">+ Add</button>
                </div>
                <div class="section">
                    <div style="font-weight: bold; margin-bottom: 12px;">This Month</div>
                    ${Object.keys(categoryTotals).length > 0 ? `
                        ${Object.entries(categoryTotals).map(([category, amount]) => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 14px; color: #6b7280;">${category}</span>
                                <span style="font-weight: 600;">‚Çπ${amount.toLocaleString()}</span>
                            </div>
                        `).join('')}
                        <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #e5e7eb; font-weight: bold;">
                            <span>Total</span>
                            <span style="color: #ef4444;">‚Çπ${stats.totalExpenditure.toLocaleString()}</span>
                        </div>
                    ` : '<div style="color: #9ca3af;">No expenses</div>'}
                </div>
                ${state.expenditures.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => `
                    <div class="section">
                        <div class="item-header">
                            <div style="flex: 1;">
                                <div class="item-title">${exp.description}</div>
                                <div class="item-subtitle">${new Date(exp.date).toLocaleDateString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #ef4444;">‚Çπ${exp.amount}</div>
                                <div style="margin-top: 4px;">
                                    <button class="edit-btn" onclick='event.stopPropagation(); openEditExpenditure(${JSON.stringify(exp).replace(/'/g, "&apos;")})'>Edit</button>
                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteExpenditure(${exp.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="item-footer">
                            <span class="category-tag">${exp.category}</span>
                            ${exp.vendor ? `<span class="vendor-tag">${exp.vendor}</span>` : ''}
                            <span class="vendor-tag">${exp.paymentMethod}</span>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function render() {
            const app = document.getElementById('app');
            let content = '';
            if (state.activeTab === 'dashboard') content = renderDashboard();
            else if (state.activeTab === 'flats') content = renderFlats();
            else if (state.activeTab === 'expenses') content = renderExpenses();
            
            const monthDisplay = new Date(state.selectedMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            app.innerHTML = `
                <div class="header">
                    <h1>Maintenance Manager</h1>
                    <p>Track apartment fees & expenses</p>
                </div>
                <div class="month-selector">
                    <label>Select Month</label>
                    <input type="month" value="${state.selectedMonth}" min="${START_MONTH}" onchange="setSelectedMonth(this.value)">
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${monthDisplay}</div>
                </div>
                <div class="content">${content}</div>
                <div class="bottom-nav">
                    <button class="nav-btn ${state.activeTab === 'dashboard' ? 'active' : ''}" onclick="setActiveTab('dashboard')">
                        <div class="nav-icon">üìä</div>
                        <div class="nav-label">Dashboard</div>
                    </button>
                    <button class="nav-btn ${state.activeTab === 'flats' ? 'active' : ''}" onclick="setActiveTab('flats')">
                        <div class="nav-icon">üè¢</div>
                        <div class="nav-label">Flats</div>
                    </button>
                    <button class="nav-btn ${state.activeTab === 'expenses' ? 'active' : ''}" onclick="setActiveTab('expenses')">
                        <div class="nav-icon">üí∏</div>
                        <div class="nav-label">Expenses</div>
                    </button>
                </div>
                ${renderModals()}
            `;
        }
        
        function renderModals() {
            const stats = getMonthlyStats();
            const dateRange = getDateRangeForMonth(state.paymentMonthForDate);
            let html = '';
            
            if (state.modals.collectionDetails) {
                html += `<div class="modal-overlay" onclick="closeModal('collectionDetails')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Collections</div>
                <button class="close-btn" onclick="closeModal('collectionDetails')">√ó</button>
                </div><div class="modal-body">
                <div class="balance-card">
                    <div class="balance-row"><span class="balance-label">Total</span><span class="balance-value">‚Çπ${stats.totalCollected.toLocaleString()}</span></div>
                    <div class="balance-row"><span class="balance-label">Cash</span><span class="balance-value" style="color: #10b981;">‚Çπ${stats.cashCollections.toLocaleString()}</span></div>
                    <div class="balance-row"><span class="balance-label">Bank</span><span class="balance-value" style="color: #3b82f6;">‚Çπ${stats.bankCollections.toLocaleString()}</span></div>
                </div></div></div></div>`;
            }
            
            if (state.modals.expenditureDetails) {
                html += `<div class="modal-overlay" onclick="closeModal('expenditureDetails')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Expenditures</div>
                <button class="close-btn" onclick="closeModal('expenditureDetails')">√ó</button>
                </div><div class="modal-body">
                <div class="balance-card">
                    <div class="balance-row"><span class="balance-label">Total</span><span class="balance-value">‚Çπ${stats.totalExpenditure.toLocaleString()}</span></div>
                </div></div></div></div>`;
            }
            
            if (state.modals.arrearsDetails) {
                html += `<div class="modal-overlay" onclick="closeModal('arrearsDetails')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Arrears</div>
                <button class="close-btn" onclick="closeModal('arrearsDetails')">√ó</button>
                </div><div class="modal-body">
                <div class="balance-card">
                    <div class="balance-row"><span class="balance-label">Total</span><span class="balance-value" style="color: #f59e0b;">‚Çπ${stats.totalArrears.toLocaleString()}</span></div>
                </div></div></div></div>`;
            }
            
            if (state.modals.addFlat) {
                html += `<div class="modal-overlay" onclick="closeModal('addFlat')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Add Flat</div>
                <button class="close-btn" onclick="closeModal('addFlat')">√ó</button>
                </div><div class="modal-body">
                <div class="info-box">üí° Opening balance: negative = arrears, positive = advance</div>
                <form onsubmit="addFlat(event)">
                    <div class="form-group"><label class="form-label">Flat Number *</label>
                    <input type="text" name="flatNumber" class="form-input" placeholder="A-101" required></div>
                    <div class="form-group"><label class="form-label">Owner Name *</label>
                    <input type="text" name="ownerName" class="form-input" required></div>
                    <div class="form-group"><label class="form-label">Monthly Fee (‚Çπ) *</label>
                    <input type="number" name="monthlyFee" class="form-input" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Phone</label>
                    <input type="tel" name="phoneNumber" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Opening Balance (Jan 2026)</label>
                    <input type="number" name="openingArrears" class="form-input" placeholder="-5000 or +5000" step="0.01"></div>
                    <button type="submit" class="submit-btn blue">Add Flat</button>
                </form></div></div></div>`;
            }
            
            if (state.modals.addPayment) {
                html += `<div class="modal-overlay" onclick="closeModal('addPayment')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Record Payment</div>
                <button class="close-btn" onclick="closeModal('addPayment')">√ó</button>
                </div><div class="modal-body">
                <form onsubmit="recordPayment(event)">
                    <div class="form-group"><label class="form-label">Flat *</label>
                    <select name="flatId" class="form-select" required>
                        ${state.selectedFlatForPayment ? `<option value="${state.selectedFlatForPayment.id}" selected>${state.selectedFlatForPayment.flatNumber} - ${state.selectedFlatForPayment.ownerName}</option>` : '<option value="">Choose</option>'}
                        ${state.flats.filter(f => !state.selectedFlatForPayment || f.id !== state.selectedFlatForPayment.id).map(f => `<option value="${f.id}">${f.flatNumber} - ${f.ownerName}</option>`).join('')}
                    </select></div>
                    <div class="form-group"><label class="form-label">Month *</label>
                    <input type="month" name="month" class="form-input" value="${state.selectedMonth}" min="${START_MONTH}" onchange="updatePaymentMonth(this.value)" required></div>
                    <div class="form-group"><label class="form-label">Date *</label>
                    <input type="date" name="date" class="form-input" min="${dateRange.minDate}" max="${dateRange.maxDate}" value="${dateRange.minDate}" required></div>
                    <div class="form-group"><label class="form-label">Amount (‚Çπ) *</label>
                    <input type="number" name="amount" class="form-input" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Method *</label>
                    <select name="method" class="form-select">
                        <option>Cash</option><option>UPI</option><option>Bank Transfer</option><option>Cheque</option>
                    </select></div>
                    <button type="submit" class="submit-btn green">Record</button>
                </form></div></div></div>`;
            }
            
            if (state.modals.addExpenditure) {
                html += `<div class="modal-overlay" onclick="closeModal('addExpenditure')"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Add Expense</div>
                <button class="close-btn" onclick="closeModal('addExpenditure')">√ó</button>
                </div><div class="modal-body">
                <form onsubmit="addExpenditure(event)">
                    <div class="form-group"><label class="form-label">Description *</label>
                    <input type="text" name="description" class="form-input" required></div>
                    <div class="form-group"><label class="form-label">Category *</label>
                    <select name="category" class="form-select">
                        <option>Cleaning</option><option>Security</option><option>Repairs</option><option>Electricity</option><option>Water</option><option>Gardening</option><option>Lift Maintenance</option><option>Pest Control</option><option>Others</option>
                    </select></div>
                    <div class="form-group"><label class="form-label">Amount (‚Çπ) *</label>
                    <input type="number" name="amount" class="form-input" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Date *</label>
                    <input type="date" name="date" class="form-input" value="${new Date().toISOString().slice(0, 10)}" min="2026-01-01" required></div>
                    <div class="form-group"><label class="form-label">Vendor</label>
                    <input type="text" name="vendor" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Payment Method *</label>
                    <select name="paymentMethod" class="form-select">
                        <option>Cash</option><option>UPI</option><option>Bank Transfer</option><option>Cheque</option>
                    </select></div>
                    <button type="submit" class="submit-btn red">Add</button>
                </form></div></div></div>`;
            }
            
            if (state.modals.editExpenditure) {
                const exp = state.modals.editExpenditure;
                html += `<div class="modal-overlay" onclick="state.modals.editExpenditure = null; render();"></div>
                <div class="modal"><div class="modal-content"><div class="modal-header">
                <div class="modal-title">Edit Expense</div>
                <button class="close-btn" onclick="state.modals.editExpenditure = null; render();">√ó</button>
                </div><div class="modal-body">
                <form onsubmit="updateExpenditure(event)">
                    <input type="hidden" name="expId" value="${exp.id}">
                    <div class="form-group"><label class="form-label">Description *</label>
                    <input type="text" name="description" class="form-input" value="${exp.description}" required></div>
                    <div class="form-group"><label class="form-label">Category *</label>
                    <select name="category" class="form-select">
                        <option ${exp.category === 'Cleaning' ? 'selected' : ''}>Cleaning</option>
                        <option ${exp.category === 'Security' ? 'selected' : ''}>Security</option>
                        <option ${exp.category === 'Repairs' ? 'selected' : ''}>Repairs</option>
                        <option ${exp.category === 'Electricity' ? 'selected' : ''}>Electricity</option>
                        <option ${exp.category === 'Water' ? 'selected' : ''}>Water</option>
                        <option ${exp.category === 'Gardening' ? 'selected' : ''}>Gardening</option>
                        <option ${exp.category === 'Lift Maintenance' ? 'selected' : ''}>Lift Maintenance</option>
                        <option ${exp.category === 'Pest Control' ? 'selected' : ''}>Pest Control</option>
                        <option ${exp.category === 'Others' ? 'selected' : ''}>Others</option>
                    </select></div>
                    <div class="form-group"><label class="form-label">Amount (‚Çπ) *</label>
                    <input type="number" name="amount" class="form-input" value="${exp.amount}" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Date *</label>
                    <input type="date" name="date" class="form-input" value="${exp.date}" min="2026-01-01" required></div>
                    <div class="form-group"><label class="form-label">Vendor</label>
                    <input type="text" name="vendor" class="form-input" value="${exp.vendor || ''}"></div>
                    <div class="form-group"><label class="form-label">Payment Method *</label>
                    <select name="paymentMethod" class="form-select">
                        <option ${(exp.paymentMethod === 'Cash' || !exp.paymentMethod) ? 'selected' : ''}>Cash</option>
                        <option ${exp.paymentMethod === 'UPI' ? 'selected' : ''}>UPI</option>
                        <option ${exp.paymentMethod === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                        <option ${exp.paymentMethod === 'Cheque' ? 'selected' : ''}>Cheque</option>
                    </select></div>
                    <button type="submit" class="submit-btn blue">Update</button>
                </form></div></div></div>`;
            }
            
            return html;
        }
        
        loadData();
        render();
    </script>
</body>
</html>
